#!/bin/bash
# Katzenschreck Health Check Script
# Generated by Ansible on {{ ansible_date_time.iso8601 }}

SERVICE_NAME="{{ service_name }}"
KATZENSCHRECK_DIR="{{ katzenschreck_dir }}"
LOG_FILE="$KATZENSCHRECK_DIR/logs/health_check.log"

# Create log directory if it doesn't exist
mkdir -p "$KATZENSCHRECK_DIR/logs"

# Function to log messages
log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_FILE"
}

# Check if service is running
if ! systemctl is-active --quiet "$SERVICE_NAME"; then
    log_message "ERROR: Service $SERVICE_NAME is not running"
    systemctl restart "$SERVICE_NAME"
    log_message "INFO: Attempted to restart $SERVICE_NAME"
    exit 1
fi

# Check if Python process is running
if ! pgrep -f "cat_detector.main" > /dev/null; then
    log_message "ERROR: Python process not found"
    systemctl restart "$SERVICE_NAME"
    log_message "INFO: Attempted to restart $SERVICE_NAME"
    exit 1
fi

# Check disk space
DISK_USAGE=$(df "$KATZENSCHRECK_DIR" | awk 'NR==2 {print $5}' | sed 's/%//')
if [ "$DISK_USAGE" -gt 90 ]; then
    log_message "WARNING: Disk usage is ${DISK_USAGE}%"
fi

# Check if results directory is writable
if [ ! -w "$KATZENSCHRECK_DIR/results" ]; then
    log_message "ERROR: Results directory is not writable"
    exit 1
fi

log_message "INFO: Health check passed"
exit 0

